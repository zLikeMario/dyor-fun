<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="UTF-8" />
    <title>链名称实时监听</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 40px;
      }
      #chainList {
        margin-top: 20px;
      }
      #controls {
        margin-bottom: 20px;
      }
      button {
        margin-right: 10px;
      }
      .new {
        color: green;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div id="controls">
      <button id="pauseBtn">暂停</button>
      <button id="startBtn">开始</button>
    </div>
    <ul id="chainList"></ul>
    <audio id="dingdong" src="./dingdong.mp3" preload="auto"></audio>
    <audio id="gu" src="./Owl-hoot-sound-effect.mp3" preload="auto"></audio>
    <audio id="ge" src="./echo-sound-effect.mp3" preload="auto"></audio>
    <script>
      let ws;
      let paused = true;
      let lastChains = [];
      const chainList = document.getElementById("chainList");
      const pauseBtn = document.getElementById("pauseBtn");
      const startBtn = document.getElementById("startBtn");
      if (paused) {
        pauseBtn.disabled = true;
      } else {
        startBtn.disabled = true;
      }

      const dingdong = document.getElementById("dingdong");
      const gu = document.getElementById("gu");
      const ge = document.getElementById("ge");

      const sleep = (interval = 1000) =>
        new Promise((resolve) => setTimeout(resolve, interval));

      const ID_KEY = "latest-id";
      const getLatestId = () => {
        return window.localStorage.getItem(ID_KEY);
      };
      const setLatestId = (v) => {
        return window.localStorage.setItem(ID_KEY, v);
      };
      async function listerList() {
        const response = await fetch(
          "https://www.app.bitagent.io/api/agents?marketType=internal&pageIndex=1&pageSize=10&orderby=&ordering=&search=&direction="
        );
        const result = await response.json();
        const list = result.data;
        const latestId = list[0].id;
        if (getLatestId() !== latestId) {
          dingdong.play();
        }
        setLatestId(latestId);
        return list;
      }

      const MENU_KEY = "latest-menu";
      const getMenus = () => {
        return window.localStorage.getItem(MENU_KEY);
      };
      const setMenus = (v) => {
        return window.localStorage.setItem(MENU_KEY, v);
      };

      const TAB_KEY = "latest-tab";
      const getTabs = () => {
        return window.localStorage.getItem(TAB_KEY);
      };
      const setTabs = (v) => {
        return window.localStorage.setItem(TAB_KEY, v);
      };

      function connectWS() {
        ws = new WebSocket("ws://" + location.hostname + ":3000");
        ws.onmessage = function (event) {
          if (paused) return;
          let data;
          try {
            data = JSON.parse(event.data);
            chainList.innerHTML = "";
            const li = document.createElement("li");
            li.innerHTML = data.menus;
            const li2 = document.createElement("li");
            li2.innerHTML = data.tabs;
            chainList.append(li, li2);
            if (getMenus() !== data.menus) {
              console.log("gu menu change");
              gu.play();
            }
            if (getTabs() !== data.tabs) {
              console.log("ge tabs change");
              ge.play();
            }
            setMenus(data.menus);
            setTabs(data.tabs);
          } catch (e) {
            return;
          }
        };
        ws.onclose = function () {
          setTimeout(connectWS, 2000); // 自动重连
        };
      }

      let timer;
      pauseBtn.onclick = function () {
        paused = true;
        pauseBtn.disabled = true;
        startBtn.disabled = false;
        clearInterval(timer);
      };
      startBtn.onclick = async function () {
        paused = false;
        pauseBtn.disabled = false;
        startBtn.disabled = true;

        connectWS();
        timer = setInterval(() => {
          listerList();
        }, 3000);
      };
    </script>
  </body>
</html>
